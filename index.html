<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‚ú® „Éû„Éç„Éº„Çø„Ç§„ÉóË®∫Êñ≠Ôºà„Éï„É´Ê©üËÉΩÁâàÔºâ ‚ú®</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <style>
        :root {
            --primary-pink: #FF69B4;
            --soft-pink: #FFF0F5;
            --mint-blue: #B2EBF2;
            --text-dark: #444;
        }

        body {
            font-family: "Hiragino Kaku Gothic ProN", "„É°„Ç§„É™„Ç™", sans-serif;
            background-color: var(--soft-pink);
            background-image: radial-gradient(#FFD1DC 2px, transparent 2px);
            background-size: 30px 30px;
            color: var(--text-dark);
            text-align: center;
            padding: 15px; margin: 0;
        }

        .container {
            max-width: 500px; margin: 10px auto;
            background: white; border-radius: 40px;
            padding: 25px 20px; box-shadow: 0 10px 0 #FFC0CB;
            border: 8px solid var(--mint-blue); position: relative;
        }

        .container::before { content: "üéÄ"; font-size: 50px; position: absolute; top: -35px; right: -5px; transform: rotate(15deg); }

        h1 { color: var(--primary-pink); font-size: 22px; text-shadow: 2px 2px 0 #fff; margin-bottom: 20px; }

        .code-input {
            padding: 15px; font-size: 24px; width: 150px; border-radius: 20px;
            border: 3px dashed var(--mint-blue); text-align: center; color: var(--primary-pink);
            outline: none; background: #F0FDFF; letter-spacing: 4px;
        }

        .btn-main {
            background: linear-gradient(#FFEB3B, #FBC02D); color: #795548; border: none;
            border-radius: 50px; padding: 16px 30px; font-size: 18px; font-weight: bold;
            cursor: pointer; box-shadow: 0 6px 0 #F9A825; width: 90%; transition: 0.2s;
        }

        .progress-bar-container { width: 100%; background: #E0F7FA; border-radius: 20px; margin-bottom: 20px; height: 12px; overflow: hidden; border: 2px solid var(--mint-blue); }
        .progress-bar { height: 100%; background: repeating-linear-gradient(45deg, #FFD1DC, #FFD1DC 10px, #FFB6C1 10px, #FFB6C1 20px); width: 0%; transition: width 0.4s ease; }

        .question-box { font-size: 18px; font-weight: bold; color: #00838F; margin-bottom: 20px; padding: 20px; background: #F1FDFF; border-radius: 25px; border: 2px dashed var(--mint-blue); }
        .option-btn {
            background: white; border: 3px solid #FFD1DC; border-radius: 30px; padding: 14px 18px;
            font-size: 15px; cursor: pointer; font-weight: bold; box-shadow: 0 4px 0 #FFD1DC; transition: 0.2s;
            width: 100%;
        }

        .result-desc-box {
            text-align: left; background: #FFF9FA; padding: 20px; border-radius: 25px;
            border: 2px solid #FFD1DC; font-size: 15px; margin-top: 15px;
        }
        .desc-text { color: #555; line-height: 1.8; margin-bottom: 15px; white-space: pre-wrap; }
        .advice-box {
            background: #E0F7FA; padding: 15px; border-radius: 15px; border-left: 5px solid #00BCD4;
            font-size: 14px; color: #006064; font-weight: bold; margin-top: 10px;
        }

        #quiz-area, #result-area { display: none; }
        .fade-in { animation: fadeIn 0.6s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<div class="container">
    <div id="start-screen">
        <h1>‚ú® „Éû„Éç„Éº„Çø„Ç§„ÉóË®∫Êñ≠ ‚ú®</h1>
        <p id="loading-message" style="font-size:12px; color:#B0BEC5;">È≠îÊ≥ï„Çí„Åü„ÇÅ„Å¶„ÅÑ„Åæ„Åô...üîã</p>
        <div style="margin: 25px 0;">
            <input type="tel" id="group-code" class="code-input" maxlength="4" placeholder="0000">
            <p id="code-error" style="color:#FF5252; font-size:13px; font-weight:bold; display:none;">‚ö†Ô∏è „Ç≥„Éº„Éâ„Åå„Å°„Åå„ÅÜ„Åø„Åü„ÅÑÔºÅ</p>
        </div>
        <button class="btn-main" id="start-button" onclick="startGame()" disabled>Ë®∫Êñ≠„Çí„ÅØ„Åò„ÇÅ„ÇãÔºÅ üíñ</button>
    </div>

    <div id="quiz-area">
        <p style="color:#0097A7; font-weight:bold; font-size:14px;">„Åó„Å§„ÇÇ„Çì <span id="q-number">1</span> / <span id="q-total">--</span></p>
        <div class="progress-bar-container"><div id="progress-bar" class="progress-bar"></div></div>
        <div id="quiz-content" class="fade-in">
            <div class="question-box" id="question-text"></div>
            <div id="options-container" style="display: flex; flex-direction: column; gap: 12px;"></div>
        </div>
    </div>

    <div id="result-area" class="fade-in">
        <div id="result-content-container" style="padding: 10px; background: white;">
            <h2 style="font-size:18px; color:#FF69B4; margin-top:0;">üéÄ Ë®∫Êñ≠ÁµêÊûú üéÄ</h2>
            <div id="result-header"></div>
            
            <div style="margin: 15px auto; width: 100%; height: 300px; position: relative;">
                <canvas id="radarChart"></canvas>
            </div>
            
            <div id="result-body" class="result-desc-box"></div>
        </div>
        <button onclick="downloadResultImage()" class="btn-main" style="background:linear-gradient(#00BCD4, #0097A7); color:white; box-shadow:0 6px 0 #006064; font-size:15px; margin-top:20px; width: 90%;">ÁµêÊûú„ÇíÂÜôÁúü„Å´‰øùÂ≠ò„Åô„Çã üì∏</button>
        <button onclick="location.reload()" style="background:none; border:none; color:#888; margin-top:15px; cursor:pointer; font-size:13px;">„ÇÇ„ÅÜ‰∏ÄÂ∫¶Ë®∫Êñ≠„Åô„Çã</button>
    </div>
</div>

<script>
    // --- ÂêÑURLË®≠ÂÆö ---
    const GOOGLE_APP_URL = "https://script.google.com/macros/s/AKfycbyQN2nMdSiiWG9xy29qc9EgwOkmnS4JCmuNAvTcLD5QPjz4wQeSztrh8pKRV4qQ9pAF/exec"; 
    const QUESTIONS_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vS9pj-nSE8qg0GTy-VDTdvpDrIJuE6OiJbnE0cOyPtHoV5W98am4V3vKES6H9rlTBfaRxWcUsLuI1VE/pub?gid=0&single=true&output=csv"; 
    const RESULTS_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vS9pj-nSE8qg0GTy-VDTdvpDrIJuE6OiJbnE0cOyPtHoV5W98am4V3vKES6H9rlTBfaRxWcUsLuI1VE/pub?gid=1023134718&single=true&output=csv";
    const CODES_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTu7LeLdHPVzh45ghYextA9pyFarqes1_VESG8wkFNVFSNekdQi85RBq3f-swWHQy8Wjr9IpQnrdncS/pub?output=csv";

    let questions = [], results = {}, validCodes = [], currentQuestionIndex = 0;
    let scores = { A: 0, B: 0, C: 0, D: 0, E: 0, F: 0, G: 0, H: 0, N: 0 };

    // È´òÁ≤æÂ∫¶CSV„Éë„Éº„ÇπÊ©üËÉΩ
    function parseCSV(text) {
        const rows = [];
        let row = [];
        let field = "";
        let inQuotes = false;
        for (let i = 0; i < text.length; i++) {
            const char = text[i];
            const nextChar = text[i+1];
            if (inQuotes) {
                if (char === '"' && nextChar === '"') { field += '"'; i++; }
                else if (char === '"') { inQuotes = false; }
                else { field += char; }
            } else {
                if (char === '"') { inQuotes = true; }
                else if (char === ',') { row.push(field); field = ""; }
                else if (char === '\r' || char === '\n') {
                    row.push(field); field = "";
                    if (row.length > 0 && row.some(x => x !== "")) rows.push(row);
                    row = [];
                    if (char === '\r' && nextChar === '\n') i++;
                } else { field += char; }
            }
        }
        if (field || row.length > 0) { row.push(field); rows.push(row); }
        return rows;
    }

    async function loadData() {
        try {
            const [qRes, rRes,
