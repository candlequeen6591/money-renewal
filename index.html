<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>âœ¨ ãƒãƒãƒ¼ã‚¿ã‚¤ãƒ—è¨ºæ–­ âœ¨</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <style>
        :root { --primary-pink: #FF69B4; --soft-pink: #FFF0F5; --mint-blue: #B2EBF2; --text-dark: #444; }
        body { font-family: "Hiragino Kaku Gothic ProN", sans-serif; background-color: var(--soft-pink); color: var(--text-dark); text-align: center; padding: 15px; margin: 0; }
        .container { max-width: 500px; margin: 10px auto; background: white; border-radius: 40px; padding: 25px 20px; box-shadow: 0 10px 0 #FFC0CB; border: 8px solid var(--mint-blue); position: relative; }
        h1 { color: var(--primary-pink); font-size: 22px; margin-bottom: 20px; }
        .code-input { padding: 15px; font-size: 24px; width: 150px; border-radius: 20px; border: 3px dashed var(--mint-blue); text-align: center; outline: none; background: #fdfdfd; }
        .btn-main { background: linear-gradient(#FFEB3B, #FBC02D); color: #795548; border: none; border-radius: 50px; padding: 16px 30px; font-size: 18px; font-weight: bold; cursor: pointer; box-shadow: 0 6px 0 #F9A825; width: 90%; transition: 0.1s; }
        .btn-main:active { transform: translateY(3px); box-shadow: 0 3px 0 #F9A825; }
        .btn-main:disabled { opacity: 0.5; }
        .question-box { font-size: 18px; font-weight: bold; color: #00838F; margin-bottom: 20px; padding: 20px; background: #F1FDFF; border-radius: 25px; border: 2px dashed var(--mint-blue); }
        .option-btn { background: white; border: 3px solid #FFD1DC; border-radius: 30px; padding: 14px 18px; font-size: 15px; cursor: pointer; margin-bottom: 12px; width: 100%; font-weight: bold; box-shadow: 0 4px 0 #FFD1DC; }
        .result-desc-box { text-align: left; background: #FFF9FA; padding: 20px; border-radius: 25px; border: 2px solid #FFD1DC; line-height: 1.8; white-space: pre-wrap; font-size: 15px; margin-top: 10px; }
        #quiz-area, #result-area { display: none; }
    </style>
</head>
<body>

<div class="container">
    <div id="start-screen">
        <h1>âœ¨ ãƒãƒãƒ¼ã‚¿ã‚¤ãƒ—è¨ºæ–­ âœ¨</h1>
        <p id="loading-msg" style="font-size:12px; color:#999;">é­”æ³•ã®ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
        <div style="margin: 25px 0;">
            <input type="tel" id="group-code" class="code-input" maxlength="4" placeholder="0000">
            <p id="code-error" style="color:#FF5252; font-weight:bold; display:none;">âš ï¸ ã‚³ãƒ¼ãƒ‰ãŒã¡ãŒã†ã¿ãŸã„ï¼</p>
        </div>
        <button id="start-btn" class="btn-main" onclick="startGame()" disabled>è¨ºæ–­ã‚’ã¯ã˜ã‚ã‚‹ï¼ ğŸ’–</button>
    </div>

    <div id="quiz-area">
        <div class="question-box" id="question-text"></div>
        <div id="options-container"></div>
    </div>

    <div id="result-area">
        <div id="result-content-container" style="background: white; padding: 10px;">
            <h2 style="color: var(--primary-pink); margin-top:0;">ğŸ€ è¨ºæ–­çµæœ ğŸ€</h2>
            <div id="result-header"></div>
            <div style="height: 320px; width: 100%; margin: 0 auto;">
                <canvas id="radarChart"></canvas>
            </div>
            <div id="result-body" class="result-desc-box"></div>
        </div>
        <button onclick="downloadResultImage()" class="btn-main" style="margin-top:20px;">çµæœã‚’å†™çœŸã«ä¿å­˜ã™ã‚‹ ğŸ“¸</button>
        <button onclick="location.reload()" style="background:none; border:none; color:#888; margin-top:20px; cursor:pointer;">ã‚‚ã†ä¸€åº¦ã‚„ã‚‹</button>
    </div>
</div>

<script>
    // --- éŸ³æº ---
    const soundTap = new Audio('https://otologic.jp/free/se/bin/button03.mp3'); 
    const soundSuccess = new Audio('https://otologic.jp/free/se/bin/tada01.mp3'); 
    const soundError = new Audio('https://otologic.jp/free/se/bin/error01.mp3'); 

    const Q_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vS9pj-nSE8qg0GTy-VDTdvpDrIJuE6OiJbnE0cOyPtHoV5W98am4V3vKES6H9rlTBfaRxWcUsLuI1VE/pub?gid=0&single=true&output=csv"; 
    const R_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vS9pj-nSE8qg0GTy-VDTdvpDrIJuE6OiJbnE0cOyPtHoV5W98am4V3vKES6H9rlTBfaRxWcUsLuI1VE/pub?gid=1023134718&single=true&output=csv";
    const C_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTu7LeLdHPVzh45ghYextA9pyFarqes1_VESG8wkFNVFSNekdQi85RBq3f-swWHQy8Wjr9IpQnrdncS/pub?output=csv";

    let questions = [], resultsMaster = {}, validCodes = [], currentIdx = 0;
    let scores = { A:0, B:0, C:0, D:0, E:0, F:0, G:0, H:0, N:0 };
    let myChart = null;

    // ç²¾å¯†CSVãƒ‘ãƒ¼ã‚¹é–¢æ•°
    function parseCSV(text) {
        const rows = []; let row = []; let field = ""; let inQuotes = false;
        const cleanText = text.replace(/\r/g, "");
        for (let i = 0; i < cleanText.length; i++) {
            const char = cleanText[i];
            if (inQuotes) {
                if (char === '"' && cleanText[i+1] === '"') { field += '"'; i++; }
                else if (char === '"') inQuotes = false;
                else field += char;
            } else {
                if (char === '"') inQuotes = true;
                else if (char === ',') { row.push(field); field = ""; }
                else if (char === '\n') {
                    row.push(field); field = "";
                    if (row.join("").trim() !== "") rows.push(row);
                    row = [];
                } else field += char;
            }
        }
        if (field || row.length > 0) { row.push(field); rows.push(row); }
        return rows;
    }

    async function init() {
        try {
            const [qTxt, rTxt, cTxt] = await Promise.all([
                fetch(Q_CSV).then(r => r.text()),
                fetch(R_CSV).then(r => r.text()),
                fetch(C_CSV).then(r => r.text())
            ]);
            
            // è³ªå•ãƒ‘ãƒ¼ã‚¹
            parseCSV(qTxt).slice(1).forEach(c => {
                if(c.length < 2) return;
                const opts = [];
                for(let i=1; i<=3; i++) {
                    if(c[i]) {
                        const m = c[i].match(/(.*)\((.)\)/);
                        if(m) opts.push({ text: m[1].trim(), type: m[2].toUpperCase() });
                    }
                }
                opts.push({ text: "ã©ã‚Œã‚‚ã‚ã¦ã¯ã¾ã‚‰ãªã„", type: "N" });
                questions.push({ text: c[0], options: opts });
            });

            // çµæœãƒ‘ãƒ¼ã‚¹
            parseCSV(rTxt).slice(1).forEach(c => {
                if(c[0]) resultsMaster[c[0].trim().toUpperCase()] = { animal:c[1], title:c[2], catch:c[3], desc:c[4] };
            });

            validCodes = cTxt.split(/\n/).map(l => l.trim()).filter(l => l);
            document.getElementById('loading-msg').innerText = "ã˜ã‚…ã‚“ã³å®Œäº†ï¼âœ¨";
            document.getElementById('start-btn').disabled = false;
        } catch (e) { 
            document.getElementById('loading-msg').innerText = "é€šä¿¡ã‚¨ãƒ©ãƒ¼ğŸ˜¢ å†èª­ã¿è¾¼ã¿ã—ã¦ã­"; 
        }
    }

    function startGame() {
        // éŸ³å£°ã‚’ã‚¢ãƒ³ãƒ­ãƒƒã‚¯ï¼ˆiOS/Safariå¯¾ç­–ï¼‰
        [soundTap, soundSuccess, soundError].forEach(s => { s.play(); s.pause(); s.currentTime = 0; });

        const code = document.getElementById('group-code').value;
        if (validCodes.includes(code)) {
            soundTap.play();
            document.getElementById('start-screen').style.display = 'none';
            document.getElementById('quiz-area').style.display = 'block';
            showQuestion();
        } else {
            soundError.play();
            document.getElementById('code-error').style.display = 'block';
        }
    }

    function showQuestion() {
        const q = questions[currentIdx];
        document.getElementById('question-text').innerText = q.text;
        const container = document.getElementById('options-container');
        container.innerHTML = "";
        q.options.forEach(opt => {
            const btn = document.createElement('button');
            btn.innerText = opt.text;
            btn.className = 'option-btn';
            btn.onclick = () => {
                soundTap.currentTime = 0;
                soundTap.play();
                scores[opt.type]++;
                currentIdx++;
                if (currentIdx < questions.length) showQuestion(); else showResult();
            };
            container.appendChild(btn);
        });
    }

    function showResult() {
        soundSuccess.play();
        confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
        document.getElementById('quiz-area').style.display = 'none';
        document.getElementById('result-area').style.display = 'block';

        let maxType = "A", maxScore = -1;
        for (let t in scores) { 
            if(t !== 'N' && scores[t] > maxScore) { maxScore = scores[t]; maxType = t; } 
        }

        const res = resultsMaster[maxType] || { animal: "ğŸŒˆ", title: "ã«ã˜ã„ã‚", catch: "ç„¡é™ã®å¯èƒ½æ€§ï¼", desc: "ã‚­ãƒŸã¯è‡ªç”±ã ï¼" };
        document.getElementById('result-header').innerHTML = `<span style="font-size:70px;">${res.animal}</span><div style="font-size:24px; color:#FF1493; font-weight:bold;">${res.title}</div><p style="font-weight:bold; color:var(--primary-pink); margin:5px 0;">${res.catch}</p>`;
        document.getElementById('result-body').innerText = res.desc;

        const currentData = [
            scores.A + scores.G + scores.C, // å®ˆã‚‹
            scores.B + scores.F,           // ä½¿ã†
            scores.E + scores.H,           // å¢—ã‚„ã™
            scores.D * 2                   // åˆ†ã‘ã‚‹
        ];

        const lastDataStr = localStorage.getItem('last_money_score');
        const datasets = [{
            label: 'ä»Šå›ã®ã‚­ãƒŸ',
            data: currentData,
            backgroundColor: 'rgba(255, 105, 180, 0.4)',
            borderColor: '#FF69B4',
            borderWidth: 3,
            pointBackgroundColor: '#FF69B4'
        }];

        if (lastDataStr) {
            datasets.push({
                label: 'å‰å›ã®ã‚­ãƒŸ',
                data: JSON.parse(lastDataStr),
                backgroundColor: 'rgba(160, 160, 160, 0.1)',
                borderColor: '#A0A0A0',
                borderWidth: 2,
                borderDash: [5, 5]
            });
        }
        localStorage.setItem('last_money_score', JSON.stringify(currentData));

        const ctx = document.getElementById('radarChart').getContext('2d');
        if (myChart) myChart.destroy();
        myChart = new Chart(ctx, {
            type: 'radar',
            data: { labels: ['å®ˆã‚‹', 'ä½¿ã†', 'å¢—ã‚„ã™', 'åˆ†ã‘ã‚‹'], datasets: datasets },
            options: {
                responsive: true, maintainAspectRatio: false,
                scales: { r: { beginAtZero: true, suggestedMax: 5, ticks: { display: false }, grid: { color: '#E0E0E0' } } },
                plugins: { legend: { display: !!lastDataStr, position: 'bottom' } }
            }
        });
    }

    function downloadResultImage() {
        soundTap.play();
        const area = document.getElementById('result-content-container');
        html2canvas(area, { scale: 2, backgroundColor: "#FFF0F5" }).then(canvas => {
            const link = document.createElement('a');
            link.download = 'ãƒãƒãƒ¼è¨ºæ–­çµæœ.png';
            link.href = canvas.toDataURL();
            link.click();
        });
    }

    window.onload = init;
</script>
</body>
</html>
