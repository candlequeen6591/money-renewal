<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚ãã‚ãï¼ãƒãƒãƒ¼ã‚¿ã‚¤ãƒ—è¨ºæ–­ï¼</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <style>
        /* --- ã‹ã‚ã„ã„ãƒ‡ã‚¶ã‚¤ãƒ³è¨­å®š --- */
        body {
            font-family: "Hiragino Kaku Gothic ProN", "ãƒ¡ã‚¤ãƒªã‚ª", sans-serif;
            background-color: #FFF0F5; /* ãƒ‘ã‚¹ãƒ†ãƒ«ãƒ”ãƒ³ã‚¯ */
            background-image: radial-gradient(#FFD1DC 2px, transparent 2px);
            background-size: 30px 30px; /* ãƒ‰ãƒƒãƒˆèƒŒæ™¯ */
            color: #444;
            text-align: center;
            padding: 20px;
            margin: 0;
            user-select: none;
        }

        .container {
            max-width: 500px;
            margin: 20px auto;
            background: white;
            border-radius: 40px; /* è§’ã‚’ã‹ãªã‚Šä¸¸ã */
            padding: 35px;
            box-shadow: 0 10px 0 #FFC0CB; /* ä¸‹ã«åšã¿ */
            border: 8px solid #B2EBF2; /* ãƒŸãƒ³ãƒˆã‚°ãƒªãƒ¼ãƒ³ã®å¤ªæ  */
            position: relative;
            transition: all 0.3s ease;
        }

        /* ãƒªãƒœãƒ³é¢¨ã®è£…é£¾ï¼ˆæ“¬ä¼¼è¦ç´ ï¼‰ */
        .container::before {
            content: "ğŸ€";
            font-size: 50px;
            position: absolute;
            top: -35px;
            right: -10px;
            transform: rotate(15deg);
        }

        h1 {
            color: #FF69B4;
            font-size: 24px;
            margin-bottom: 20px;
            text-shadow: 2px 2px 0 #fff, 4px 4px 0 #FFE4E1;
        }

        /* å…¥åŠ›ã‚¨ãƒªã‚¢ */
        .input-label {
            display: block;
            font-weight: bold;
            color: #0097A7;
            margin-bottom: 10px;
        }

        .code-input {
            padding: 15px;
            font-size: 24px;
            width: 160px;
            border-radius: 20px;
            border: 3px dashed #B2EBF2;
            text-align: center;
            letter-spacing: 5px;
            color: #FF69B4;
            outline: none;
            background: #F0FDFF;
        }

        /* ã·ã£ãã‚Šãƒœã‚¿ãƒ³ */
        .start-btn-large {
            background: linear-gradient(#FFEB3B, #FBC02D);
            color: #795548;
            border: none;
            border-radius: 50px;
            padding: 18px 40px;
            font-size: 20px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 6px 0 #F9A825;
            width: 90%;
            margin: 20px auto 0;
            display: block;
            transition: 0.2s;
        }

        .start-btn-large:active {
            transform: translateY(4px);
            box-shadow: 0 2px 0 #F9A825;
        }

        .start-btn-large:disabled {
            background: #E0E0E0;
            box-shadow: 0 6px 0 #BDBDBD;
            color: #9E9E9E;
        }

        /* ã—ã¾ã—ã¾ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ */
        .progress-bar-container {
            width: 100%;
            background-color: #E0F7FA;
            border-radius: 20px;
            margin-bottom: 25px;
            height: 18px;
            overflow: hidden;
            border: 2px solid #B2EBF2;
        }
        .progress-bar {
            height: 100%;
            background: repeating-linear-gradient(45deg, #FFD1DC, #FFD1DC 10px, #FFB6C1 10px, #FFB6C1 20px);
            width: 0%;
            transition: width 0.5s ease;
        }

        /* è³ªå•ãƒœãƒƒã‚¯ã‚¹ */
        .question-box {
            font-size: 18px;
            font-weight: bold;
            color: #00838F;
            margin-bottom: 25px;
            padding: 25px;
            background-color: #F1FDFF;
            border-radius: 25px;
            border: 2px dashed #B2EBF2;
        }

        /* é¸æŠè‚¢ãƒœã‚¿ãƒ³ */
        .option-btn {
            background: white;
            color: #444;
            border: 3px solid #FFD1DC;
            border-radius: 30px;
            padding: 15px 20px;
            font-size: 16px;
            cursor: pointer;
            font-weight: bold;
            text-align: center;
            transition: 0.2s;
            box-shadow: 0 4px 0 #FFD1DC;
        }
        .option-btn:hover { background: #FFF9FA; border-color: #FF69B4; }
        .option-btn:active { transform: translateY(3px); box-shadow: 0 1px 0 #FFD1DC; }
        .neutral-btn { border-color: #CFD8DC; box-shadow: 0 4px 0 #CFD8DC; color: #78909C; }

        /* çµæœã‚¨ãƒªã‚¢ */
        .animal-icon { font-size: 90px; margin: 10px 0; display: block; filter: drop-shadow(3px 3px 0 #fff); }
        .type-title { font-size: 26px; color: #FF1493; font-weight: bold; margin-bottom: 5px; }
        .desc { font-size: 14px; line-height: 1.8; text-align: left; background: #FFF9FA; padding: 20px; border-radius: 25px; border: 2px solid #FFD1DC; color: #555; }

        /* éè¡¨ç¤ºåˆ¶å¾¡ */
        #quiz-area, #result-area { display: none; }
        .error-message { color: #FF5252; font-size: 14px; font-weight: bold; margin-top: 10px; display: none; }
        #back-button { background: none; border: none; color: #888; text-decoration: underline; cursor: pointer; margin-top: 15px; }

        .fade-in { animation: fadeIn 0.6s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
    </style>
</head>
<body>

<div class="container">
    <div id="start-screen">
        <h1>âœ¨ ãƒãƒãƒ¼ã‚¿ã‚¤ãƒ—è¨ºæ–­ âœ¨</h1>
        <p id="loading-message" style="font-size:12px; color:#B0BEC5;">é­”æ³•ã‚’ã‹ã‘ã¦ã„ã¾ã™...ğŸª„</p>
        
        <div style="margin: 30px 0;">
            <label class="input-label">å‚åŠ ã‚³ãƒ¼ãƒ‰ã‚’å…¥ã‚Œã¦ã­ âœ¨</label>
            <input type="tel" id="group-code" class="code-input" maxlength="4" placeholder="0000">
            <div id="code-error" class="error-message">âš ï¸ ã‚³ãƒ¼ãƒ‰ãŒã¡ãŒã†ã¿ãŸã„...ï¼</div>
        </div>

        <button class="start-btn-large" id="start-button" onclick="startGame()" disabled>è¨ºæ–­ã‚’ã¯ã˜ã‚ã‚‹ï¼ ğŸ’–</button>
    </div>

    <div id="quiz-area">
        <p style="color:#0097A7; font-weight:bold;">ã—ã¤ã‚‚ã‚“ <span id="q-number">1</span> / <span id="q-total">--</span></p>
        <div class="progress-bar-container"><div id="progress-bar" class="progress-bar"></div></div>
        
        <div id="quiz-content" class="fade-in">
            <div class="question-box" id="question-text"></div>
            <div id="options-container" style="display: flex; flex-direction: column; gap: 15px;"></div>
        </div>
        <button id="back-button" onclick="goBack()">ã²ã¨ã¤å‰ã«æˆ»ã‚‹ âª</button>
    </div>

    <div id="result-area" class="fade-in">
        <div id="result-content-container" style="padding: 10px;">
            <h1 style="font-size: 20px;">ğŸ€ è¨ºæ–­çµæœ ğŸ€</h1>
            <div id="result-content"></div>
            <div style="margin: 20px auto; height: 260px; width: 100%;">
                <canvas id="radarChart"></canvas>
            </div>
            <div id="result-desc"></div>
        </div>
        <button onclick="downloadResultImage()" class="start-btn-large" style="background:linear-gradient(#00BCD4, #0097A7); color:white; box-shadow:0 6px 0 #006064; font-size:16px;">çµæœã‚’å†™çœŸã«ä¿å­˜ã™ã‚‹ ğŸ“¸</button>
        <button onclick="location.reload()" style="background:none; border:none; color:#888; margin-top:20px; cursor:pointer;">ã‚‚ã†ä¸€å›ã‚ãã¶</button>
    </div>
</div>

<script>
    // --- URLè¨­å®šã‚¨ãƒªã‚¢ ---
    const GOOGLE_APP_URL = "https://script.google.com/macros/s/AKfycbyQN2nMdSiiWG9xy29qc9EgwOkmnS4JCmuNAvTcLD5QPjz4wQeSztrh8pKRV4qQ9pAF/exec"; 
    const QUESTIONS_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vS9pj-nSE8qg0GTy-VDTdvpDrIJuE6OiJbnE0cOyPtHoV5W98am4V3vKES6H9rlTBfaRxWcUsLuI1VE/pub?gid=0&single=true&output=csv"; 
    const RESULTS_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vS9pj-nSE8qg0GTy-VDTdvpDrIJuE6OiJbnE0cOyPtHoV5W98am4V3vKES6H9rlTBfaRxWcUsLuI1VE/pub?gid=1023134718&single=true&output=csv";
    const CODES_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTu7LeLdHPVzh45ghYextA9pyFarqes1_VESG8wkFNVFSNekdQi85RBq3f-swWHQy8Wjr9IpQnrdncS/pub?output=csv";

    let questions = [], results = {}, validCodes = [], currentQuestionIndex = 0;
    let scores = { A: 0, B: 0, C: 0, D: 0, E: 0, F: 0, G: 0, H: 0, N: 0 }, scoreHistory = [];

    async function loadData() {
        try {
            const [qRes, rRes, cRes] = await Promise.all([
                fetch(QUESTIONS_CSV_URL).then(r => r.text()),
                fetch(RESULTS_CSV_URL).then(r => r.text()),
                fetch(CODES_CSV_URL).then(r => r.text())
            ]);
            questions = parseQuestionsCSV(qRes);
            results = parseResultsCSV(rRes);
            validCodes = cRes.split(/\r?\n/).map(l => l.trim()).filter(l => l !== "");
            document.getElementById('loading-message').innerText = "ã˜ã‚…ã‚“ã³OKï¼";
            document.getElementById('q-total').innerText = questions.length;
            document.getElementById('start-button').disabled = false;
        } catch (e) {
            document.getElementById('loading-message').innerText = "ã‚¨ãƒ©ãƒ¼ï¼šãƒ‡ãƒ¼ã‚¿ãŒã¨ã©ã‹ãªã‹ã£ãŸã‚ˆ ğŸ˜¢";
        }
    }

    function startGame() {
        const inputCode = document.getElementById('group-code').value;
        if (validCodes.includes(inputCode)) {
            document.getElementById('start-screen').style.display = 'none';
            document.getElementById('quiz-area').style.display = 'block';
            showQuestion();
        } else {
            document.getElementById('code-error').style.display = 'block';
        }
    }

    function showQuestion() {
        document.getElementById('back-button').style.display = currentQuestionIndex > 0 ? 'inline-block' : 'none';
        const q = questions[currentQuestionIndex];
        document.getElementById('question-text').innerText = q.text;
        document.getElementById('q-number').innerText = currentQuestionIndex + 1;
        document.getElementById('progress-bar').style.width = (currentQuestionIndex / questions.length * 100) + "%";
        const container = document.getElementById('options-container');
        container.innerHTML = "";
        q.options.forEach(opt => {
            const btn = document.createElement('button');
            btn.innerText = opt.text;
            btn.className = 'option-btn ' + (opt.type === "N" ? 'neutral-btn' : '');
            btn.onclick = () => {
                scoreHistory.push(JSON.parse(JSON.stringify(scores)));
                scores[opt.type]++;
                currentQuestionIndex++;
                if (currentQuestionIndex < questions.length) showQuestion(); else showResult();
            };
            container.appendChild(btn);
        });
    }

    function goBack() {
        if (currentQuestionIndex > 0) {
            currentQuestionIndex--;
            scores = scoreHistory.pop();
            showQuestion();
        }
    }

    function showResult() {
        if (typeof confetti === 'function') confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 }, colors: ['#FF69B4', '#B2EBF2', '#FFEB3B'] });
        document.getElementById('quiz-area').style.display = 'none';
        document.getElementById('result-area').style.display = 'block';
        let maxType = "A", maxScore = 0;
        for (let t in scores) { if(t !== 'N' && scores[t] > maxScore) { maxScore = scores[t]; maxType = t; } }
        if (scores.N > maxScore) maxType = "N";
        const res = results[maxType];
        document.getElementById('result-content').innerHTML = `<span class="animal-icon">${res.animal}</span><div class="type-title">${res.title}</div><p style="font-weight:bold; color:#FF69B4;">${res.catch}</p>`;
        document.getElementById('result-desc').innerHTML = `<div class="desc">${res.desc}</div>`;
        drawChart(scores);
        sendResultToDatabase(maxType, maxScore);
    }

    function drawChart(s) {
        const ctx = document.getElementById('radarChart').getContext('2d');
        new Chart(ctx, {
            type: 'radar',
            data: {
                labels: ['å®ˆã‚‹', 'ä½¿ã†', 'å¢—ã‚„ã™', 'åˆ†ã‘ã‚‹'],
                datasets: [{
                    data: [s.A+s.G+s.C, s.B+s.F, s.E+s.H, s.D*2],
                    backgroundColor: 'rgba(255, 182, 193, 0.5)', borderColor: '#FF69B4', borderWidth: 3, pointBackgroundColor: '#FF1493'
                }]
            },
            options: { scales: { r: { beginAtZero: true, suggestedMax: 8, ticks: { display: false } } }, plugins: { legend: { display: false } } }
        });
    }

    function sendResultToDatabase(type, score) {
        const groupCode = document.getElementById('group-code').value;
        const data = new URLSearchParams({ groupCode, type, score });
        fetch(GOOGLE_APP_URL, { method: 'POST', mode: 'no-cors', body: data });
    }

    function parseQuestionsCSV(csv) {
        const rows = csv.split('\n').slice(1);
        return rows.map(row => {
            const cells = row.split(',');
            const options = [];
            for(let i=1; i<=3; i++) {
                if(cells[i]) {
                    const m = cells[i].match(/(.*)\((.)\)/);
                    if(m) options.push({ text: m[1], type: m[2] });
                }
            }
            options.push({ text: "ã©ã‚Œã‚‚ã‚ã¦ã¯ã¾ã‚‰ãªã„", type: "N" });
            return { text: cells[0], options };
        });
    }

    function parseResultsCSV(csv) {
        const rows = csv.split('\n').slice(1), obj = {};
        rows.forEach(row => {
            const c = row.split(',');
            if(c[0]) obj[c[0]] = { animal: c[1], title: c[2], catch: c[3], desc: c[4] };
        });
        return obj;
    }

    function downloadResultImage() {
        const target = document.getElementById('result-content-container');
        html2canvas(target, { backgroundColor: "#FFF0F5", scale: 2 }).then(canvas => {
            const link = document.createElement('a');
            link.download = 'è¨ºæ–­çµæœ.png';
            link.href = canvas.toDataURL();
            link.click();
        });
    }

    window.onload = loadData;
</script>
</body>
</html>
