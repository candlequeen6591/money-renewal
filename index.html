<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ’ ãƒãƒãƒ¼ã‚¿ã‚¤ãƒ—è¨ºæ–­ ğŸ’</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700;800&display=swap" rel="stylesheet">
    <style>
        :root { --primary-pink: #FF69B4; --deep-pink: #FF1493; --soft-pink: #FFF0F5; --mint-blue: #B2EBF2; --text-dark: #444; }
        body { font-family: 'M PLUS Rounded 1c', sans-serif; background-color: #ffeef8; color: var(--text-dark); text-align: center; padding: 15px; margin: 0; }
        .container { max-width: 480px; margin: 10px auto; background: white; border-radius: 40px; padding: 30px 20px; box-shadow: 0 15px 30px rgba(0,0,0,0.1); border: 6px solid var(--mint-blue); position: relative; }
        h1 { color: var(--primary-pink); font-size: 26px; font-weight: 800; margin-bottom: 10px; }
        .code-input { padding: 15px; font-size: 28px; width: 160px; border-radius: 25px; border: 4px dashed var(--mint-blue); text-align: center; color: var(--deep-pink); font-weight: bold; background: #faffff; outline: none; }
        .btn-main { background: linear-gradient(to bottom, #FFEB3B, #FBC02D); color: #795548; border: none; border-radius: 50px; padding: 18px 30px; font-size: 20px; font-weight: 800; cursor: pointer; box-shadow: 0 8px 0 #F9A825; width: 90%; }
        .btn-main:active { transform: translateY(4px); box-shadow: 0 4px 0 #F9A825; }
        .btn-main:disabled { opacity: 0.5; filter: grayscale(1); }
        .question-box { font-size: 20px; font-weight: 800; color: #007c91; margin-bottom: 25px; padding: 25px; background: #f1fdff; border-radius: 30px; border: 2px solid var(--mint-blue); }
        .option-btn { background: white; border: 3px solid #FFD1DC; border-radius: 35px; padding: 16px 22px; font-size: 16px; cursor: pointer; margin-bottom: 12px; width: 100%; font-weight: bold; box-shadow: 0 5px 0 #FFD1DC; text-align: left; }
        .animal-emoji { font-size: 90px; margin: 10px 0; display: block; animation: bounce 2s infinite; }
        .result-catch { font-size: 22px; color: var(--deep-pink); font-weight: 900; margin: 5px 0; }
        .chart-container { position: relative; height: 320px; width: 100%; margin: 10px 0; }
        .result-desc-box { text-align: left; background: #fffcfd; padding: 25px; border-radius: 30px; border: 3px solid #FFD1DC; line-height: 1.8; white-space: pre-wrap; font-size: 15px; margin-top: 20px; }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-15px); } }
        #quiz-area, #result-area { display: none; }
    </style>
</head>
<body>
<div class="container">
    <div id="start-screen">
        <h1>âœ¨ ãƒãƒãƒ¼ã‚¿ã‚¤ãƒ—è¨ºæ–­ âœ¨</h1>
        <div style="margin: 30px 0;">
            <input type="tel" id="group-code" class="code-input" maxlength="4" placeholder="1001">
            <p id="code-error" style="color:#FF5252; font-weight:bold; display:none;">âš ï¸ ã‚³ãƒ¼ãƒ‰ãŒé•ã†ã‚ˆï¼</p>
        </div>
        <button id="start-btn" class="btn-main" onclick="startGame()" disabled>è¨ºæ–­ã‚¹ã‚¿ãƒ¼ãƒˆï¼ ğŸ’–</button>
        <p id="loading-msg" style="font-size:11px; color:#bbb; margin-top: 15px;">èª­è¾¼ä¸­...</p>
    </div>
    <div id="quiz-area">
        <div id="progress-bar" style="width: 100%; height: 8px; background: #eee; border-radius: 10px; margin-bottom: 20px;">
            <div id="progress-fill" style="width: 0%; height: 100%; background: var(--primary-pink); border-radius: 10px; transition: 0.3s;"></div>
        </div>
        <div class="question-box" id="question-text"></div>
        <div id="options-container"></div>
    </div>
    <div id="result-area">
        <div id="result-content-container" style="background: white; padding: 10px; border-radius: 35px;">
            <h2 style="color: var(--primary-pink); font-size: 14px;">ğŸ€ è¨ºæ–­çµæœ ğŸ€</h2>
            <div id="result-header"></div>
            <div class="chart-container"><canvas id="radarChart"></canvas></div>
            <div id="result-body" class="result-desc-box"></div>
        </div>
        <button onclick="downloadResultImage()" class="btn-main" style="margin-top:25px; background: linear-gradient(#4CAF50, #45a049); color: white; box-shadow: 0 8px 0 #2e7d32; font-size:16px;">çµæœã‚’å†™çœŸã§ä¿å­˜ ğŸ“¸</button>
        <button onclick="location.reload()" style="background:none; border:none; color:#aaa; margin-top:20px; cursor:pointer;">æœ€åˆã«æˆ»ã‚‹</button>
    </div>
</div>

<audio id="se-select" src="https://standard-js.com/audio/select.mp3"></audio>
<audio id="se-fanfare" src="https://standard-js.com/audio/fanfare.mp3"></audio>

<script>
    // --- ğŸ”— ã™ã¹ã¦ã®æ¥ç¶šå…ˆURLã‚’çµ±åˆ ---
    const SHEET_ID = "116tuTmwNpfl4FnpSHB8jQ8MNJb8bHGmzgm2mQ8n7fdY";
    const Q_CSV = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=0`;
    const RESULTS_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vS9pj-nSE8qg0GTy-VDTdvpDrIJuE6OiJbnE0cOyPtHoV5W98am4V3vKES6H9rlTBfaRxWcUsLuI1VE/pub?gid=1023134718&single=true&output=csv";
    const GAS_URL = "https://script.google.com/macros/s/AKfycbyUi_zfv1Gsk2Yw6VnudCvEIrFP8lcRFE02Jc20Hz3CvOQxD9x4wIcYPTZpDMyBKGOD/exec";

    let questions = [], resultsMaster = {}, validCodes = new Set(), currentIdx = 0;
    let userCode = "";
    let scores = { A:0, B:0, C:0, D:0, E:0, F:0, G:0, H:0, N:0 };

    function parseCSV(text) {
        const rows = [];
        const lines = text.split(/\r?\n/);
        for (let line of lines) {
            if (!line.trim()) continue;
            const parts = line.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
            rows.push(parts.map(p => p.replace(/^"|"$/g, '').trim()));
        }
        return rows;
    }

    // â‘  ã‚³ãƒ¼ãƒ‰ã®å‚ç…§ã¨ãƒã‚¹ã‚¿ã®èª­ã¿è¾¼ã¿
    async function init() {
        try {
            // è³ªå•ã¨æœ‰åŠ¹ã‚³ãƒ¼ãƒ‰(Aåˆ—)ã®èª­ã¿è¾¼ã¿
            const qRes = await fetch(Q_CSV);
            const qTxt = await qRes.text();
            parseCSV(qTxt).slice(1).forEach(cols => {
                if (cols[0]) validCodes.add(cols[0].trim()); // Aåˆ—ï¼šã‚³ãƒ¼ãƒ‰
                if (cols[1]) {
                    const opts = [];
                    for(let i=2; i<=6; i++) {
                        if(cols[i]) {
                            const m = cols[i].match(/(.*)\((.)\)/);
                            if(m) opts.push({ text: m[1].trim(), type: m[2].toUpperCase() });
                        }
                    }
                    if(opts.length > 0) {
                        opts.push({ text: "ã©ã‚Œã‚‚ã‚ã¦ã¯ã¾ã‚‰ãªã„", type: "N" });
                        questions.push({ text: cols[1], options: opts });
                    }
                }
            });

            // â‘¤ çµæœãƒã‚¹ã‚¿(resultsã‚·ãƒ¼ãƒˆ)ã®èª­ã¿è¾¼ã¿
            const rRes = await fetch(RESULTS_MASTER_CSV);
            const rTxt = await rRes.text();
            parseCSV(rTxt).slice(1).forEach(cols => {
                if(cols[0]) {
                    resultsMaster[cols[0].trim().toUpperCase()] = { 
                        emoji: cols[1], catch: cols[2], desc: cols[3] 
                    };
                }
            });

            document.getElementById('loading-msg').innerText = "âœ¨ æº–å‚™å®Œäº†ï¼ âœ¨";
            document.getElementById('start-btn').disabled = false;
        } catch (e) { document.getElementById('loading-msg').innerText = "é€šä¿¡ã‚¨ãƒ©ãƒ¼ï¼šæ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„"; }
    }

    // â‘¡ è¨ºæ–­é–‹å§‹
    async function startGame() {
        userCode = document.getElementById('group-code').value.trim();
        if (validCodes.has(userCode)) {
            document.getElementById('start-screen').style.display = 'none';
            document.getElementById('quiz-area').style.display = 'block';
            showQuestion();
        } else {
            document.getElementById('code-error').style.display = 'block';
        }
    }

    function showQuestion() {
        const q = questions[currentIdx];
        document.getElementById('progress-fill').style.width = `${(currentIdx / questions.length) * 100}%`;
        document.getElementById('question-text').innerText = q.text;
        const container = document.getElementById('options-container');
        container.innerHTML = "";
        q.options.forEach(opt => {
            const btn = document.createElement('button');
            btn.innerText = opt.text; btn.className = 'option-btn';
            btn.onclick = () => {
                try { document.getElementById('se-select').play(); } catch(e){}
                // â‘¢ è¨ºæ–­ã«ã‚ˆã‚Šã‚¹ã‚³ã‚¢åŒ–
                if(scores[opt.type] !== undefined) scores[opt.type]++;
                currentIdx++;
                if (currentIdx < questions.length) showQuestion(); else showResult();
            };
            container.appendChild(btn);
        });
    }

    async function showResult() {
        try { document.getElementById('se-fanfare').play(); } catch(e){}
        confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
        document.getElementById('quiz-area').style.display = 'none';
        document.getElementById('result-area').style.display = 'block';

        // â‘£ ã‚¢ãƒ«ãƒ•ã‚¡ãƒ™ãƒƒãƒˆã«è½ã¨ã—è¾¼ã‚€
        let maxType = "A", maxVal = -1;
        for (let t in scores) { if(t !== 'N' && scores[t] > maxVal) { maxVal = scores[t]; maxType = t; } }

        // â‘¤ resultsã®ã‚·ãƒ¼ãƒˆã‚’å‚ç…§ã—è¡¨ç¤º
        const res = resultsMaster[maxType] || {emoji:"â“", catch:"ä¸æ˜", desc:"ã‚·ãƒ¼ãƒˆã®å†…å®¹ã‚’ç¢ºèªã—ã¦ãã ã•ã„"};
        document.getElementById('result-header').innerHTML = `<span class="animal-emoji">${res.emoji}</span><div class="result-catch">${res.catch}</div>`;
        document.getElementById('result-body').innerText = res.desc;

        // â‘¥ codesã®ã‚·ãƒ¼ãƒˆã®4æ¡ã‚¿ãƒ–ã«çµæœã‚’ä¿å­˜ï¼ˆGASé€ä¿¡ï¼‰
        if (GAS_URL.includes("http")) {
            const formData = new URLSearchParams();
            formData.append('groupCode', userCode); // ã“ã‚ŒãŒã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®ã‚¿ãƒ–åã«ãªã‚Šã¾ã™
            formData.append('type', maxType);
            formData.append('animal', res.catch);
            fetch(GAS_URL, { method: "POST", body: formData, mode: "no-cors" });
        }

        // ğŸ“Š ã‚°ãƒ©ãƒ•æç”»ï¼ˆå®ˆã‚‹ãƒ»ä½¿ã†ãƒ»å¢—ã‚„ã™ãƒ»åˆ†ã‘ã‚‹ï¼‰
        const userData = [
            scores.A + scores.G + scores.C, 
            scores.B + scores.F,           
            scores.E + scores.H,           
            scores.D * 2                   
        ];
        
        

        new Chart(document.getElementById('radarChart'), {
            type: 'radar',
            data: { 
                labels: ['å®ˆã‚‹åŠ›', 'ä½¿ã†åŠ›', 'å¢—ã‚„ã™åŠ›', 'åˆ†ã‘ã‚‹åŠ›'], 
                datasets: [
                    { label: 'ã‚ãªãŸ', data: userData, backgroundColor: 'rgba(255, 105, 180, 0.5)', borderColor: '#FF69B4', borderWidth: 4, z: 2 },
                    { label: 'å¹³å‡', data: [2, 2.5, 1.8, 1.5], backgroundColor: 'rgba(200, 200, 200, 0.2)', borderColor: '#ccc', borderWidth: 2, borderDash: [5, 5], z: 1 }
                ] 
            },
            options: { responsive: true, maintainAspectRatio: false, scales: { r: { beginAtZero: true, suggestedMax: 5 } } }
        });
    }

    function downloadResultImage() {
        html2canvas(document.getElementById('result-content-container'), { scale: 2, backgroundColor: "#ffffff" }).then(canvas => {
            const link = document.createElement('a');
            link.download = `è¨ºæ–­çµæœ_${userCode}.png`;
            link.href = canvas.toDataURL(); link.click();
        });
    }
    window.onload = init;
</script>
</body>
</html>
